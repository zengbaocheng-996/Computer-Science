# 输入输出系统和IO控制方式

![](1.png)

## 现代计算机结构

![](2.png)

"I/O"就是“输入/输出”（Input/Output）

I/O设备就是可以将数据输入到计算机，或者可以接收计算机输出数据的外部设备

## 主机如何与I/O设备进行交互？

I/O接口：又称I/O控制器（I/O Controller）、设备控制器，负责协调主机与外部设备之间的数据传输

![](3.png)

![](4.png)

I/O控制器多种多样，也会制定相应的标准，如：用于控制USB设备的IO接口、用于控制SATA3.0硬盘的IO接口等（I/O控制器就是一块芯片，常被集成在主板上）

## I/O控制器（I/O接口）

<img src="5.png" style="zoom:67%;" />

插口背后的芯片

现在的I/O接口（芯片）也会被集成在南桥芯片内部

## I/O控制方式简介

```c
#include <stdio.h>
int main(void)
{
    char i;
    scanf("%c", &i);
    printf("i = %c\n", i);
    return 0;
}
```

### CPU如何控制键盘I/O的完成？

数据流：键盘>IO接口的数据寄存器>数据总线>CPU某寄存器>主存（变量i的对应位置）

1. 程序查询方式：CPU不断轮询检查I/O控制器中的“状态寄存器”，检测到状态为“已完成“之后，再从数据寄存器取出输入数据
2. 程序中断方式：等待键盘I/O时CPU可以先去执行其他程序，键盘I/O完成后I/O控制器向CPU发出中断请求，CPU响应中断请求，并取走输入数据

![](6.png)

思考：对于快速I/O设备，如”磁盘“，每准备好一个字就给CPU发送一次中断请求，会导致什么问题？

CPU需要花大量的时间来处理中断服务程序，CPU利用率严重下降。

### DMA控制方式

DMA：Direct Memory Access，直接内存访问。

注：DMA接口，即DMA控制器，也是一种特殊的I/O控制器

<img src="7.png" style="zoom:67%;" />

DMA控制方式：主存与高速I/O设备之间有一条直接数据通路（DMA总线）。CPU向DMA接口发出”读/写命令“，并指明主存地址、磁盘地址、读写数据量等参数。

DMA控制器自动控制磁盘与主存的数据读写，每完成一整块数据读写（如1KB为一整块），才向CPU发出一次中断请求。

<img src="8.png" style="zoom:67%;" />

DMA控制器与主存每次传送1个字。当传送完一整块数据后才向CPU发出中断请求

### 通道控制方式

有的商用中型机、大型机可能会接上超多的I/O设备，如果都让CPU来管理，那么CPU就太累了

通道是具有特殊功能的处理器，能对I/O设备进行统一管理。

通道：可以理解为是”弱鸡版CPU“。通道可以识别并执行一系列通道指令，通道指令种类、功能通常比较单一

1. CPU向通道发出I/O指令。指明通道程序在内存中的位置，并指明要操作的是哪个I/O设备。CPU就可以去做其他事情
2. 通道执行内存中的通道程序，控制I/O设备完成一系列任务
3. 通道执行完规定的任务后，向CPU发出中断请求，之后CPU对中断进行处理

<img src="9.png" style="zoom:67%;" />

## I/O系统基本组成

1. I/O硬件 包括外部设备、I/O接口、I/O总线等。

   ![](10.png)

2. I/O软件 包括驱动程序、用户程序、管理程序、升级补丁等。

   - I/O指令 CPU指令的一部分

     ![](12.png)

   - 通道指令 通道能识别的指令

     通道程序提前编制好放在主存中

     在含有通道的计算机中，CPU执行I/O指令对通道发出命令，由通道执行一系列通道指令，代替CPU对I/O设备进行管理

     注：I/O指令与普通指令格式略有不同，操作码指明了CPU要对IO接口做什么，命令码指明了IO接口要对设备做什么

![](13.png)

# 外部设备

![](14.png)

外部设备也称为外围设备，是除了主机以外的、能直接或间接与计算机交换信息的装置。

输入设备

用于向计算机系统输入命令和文本、数据等信息的部件。键盘和鼠标是最基本的输入设备。

输出设备

用于将计算机系统中的信息输出到计算机外部进行显示、交换等的部件。显示器和打印机是最基本的输出设备。

外存设备

是指除计算机内存及CPU缓存等以外的存储器。硬磁盘、光盘等是最基本的外存设备。

## 输入设备

![](15.png)

## 输出设备

### 显示器

![](16.png)

![](17.png)

注：现代计算机中，显存除了作为当前显示帧的缓存，还会用于保存即将渲染的图像数据。

集成显卡计算机中，通常分配一片内存作为显存

![](18.png)

![](19.png)

![](20.png)

![](21.png)

### 打印机

![](22.png)

![](23.png)

![](24.png)

# IO接口

<img src="25.png" style="zoom:67%;" />

## 主机如何与I/O设备进行交互？

![](29.png)

I/O接口：又称I/O控制器（I/O Controller）、设备控制器，负责协调主机与外部设备之间的数据传输

## I/O接口的作用

![](26.png)

- 数据缓冲：通过数据缓冲寄存器（DBR）达到主机和外设工作速度的匹配
- 错误或状态检测：通过状态寄存器反馈设备的各种错误、状态信息，供CPU查用
- 控制和定时：接收从控制总线发来的控制信号、时钟信号
- 数据格式转换：串-并、并-串 等格式转换

## I/O接口

内部接口：内部接口与系统总线相连，实质上是与内存、CPU相连。

外部接口：外部接口通过接口电缆与外设相连，外部接口的数据传输可能是串行方式，因此I/O接口需具有串/并转换功能。

<img src="27.png" style="zoom:67%;" />

![](28.png)

## I/O接口的工作原理

<img src="30.png" style="zoom:67%;" />

1. 发命令：发送命令字到I/O控制寄存器，向设备发送命令（需要驱动程序的协助）
2. 读状态：从状态寄存器读取状态字，获得设备或I/O控制器的状态信息
3. 读/写数据：从数据缓冲寄存器发送或读取数据，完成主机与外设的数据交换

控制寄存器、状态寄存器在使用时间上是错开的，因此有的I/O接口中可将二者合二为一

IO控制器中的各种寄存器称为I/O端口

如何确定要操作的设备？

每个设备对应一组寄存器，操作不同的寄存器就是在操作不同的设备

## 接口与端口

<img src="31.png" style="zoom:67%;" />

I/O端口是指接口电路中可以被CPU直接访问的寄存器

## 统一编址vs独立编址

<img src="32.png" style="zoom:67%;" />

靠不同的地址码区分内存和I/O设备。访存类的指令都可以访问I/O端口（RISC机器常用）

<img src="33.png" style="zoom:67%;" />

靠不同的指令区分内存和I/O设备。只能用专门的I/O指令访问I/O端口（Intel处理器常用，IN、OUT就是IO指令）

## I/O端口及其编址

 ![](34.png)

## I/O接口的类型

### 按数据传送方式可分为

并行接口：一个字节或一个字所有位同时传送。

串行接口：一位一位地传送。

注：这里所说的数据传送方式指的是外设和接口一侧的传送方式，而在主机和接口一侧。接口要完成数据格式转换。

### 按主机访问I/O设备的控制方式可分为

程序查询接口

中断接口

DMA接口

### 按功能选择的灵活性可分为

可编程接口

不可编程接口

![](35.png)