# 计算机系统概述

## 计算机系统层次结构

### 计算机系统的基本组成

计算机系统由硬件和软件两部分组成。硬件是具体物理装置的总称，人们看到的各种芯片、板卡、外设、电缆等都是计算机硬件。软件包括运行在硬件上的程序、数据以及相关的文档。程序是指挥计算机操作的一个指令序列，数据是指令操作的对象。

### 计算机硬件的基本组成

1. 输入设备

   输入设备的主要功能是将程序和数据以机器所能识别和接收的信息形式传入到计算机内。最常见的就是键盘、鼠标等。

2. 输出设备

   输出设备的主要功能是将计算机处理的结果以人们所能接收的信息形式或其他系统所要求的信息形式输出。最常见的就是显示器。

3. 控制器

   控制器是计算机的指挥中心，程序就是解题步骤，控制计算机各个部件有条不紊地自动工作。

4. 存储器

   存储器是计算机的存储部件，是信息存储的核心，用来存放程序和数据。

5. 运算器

   运算器是计算机的执行部件，用于对数据进行加工处理，完成算术运算和逻辑运算。

### 计算机软件和硬件的关系

硬件与软件在逻辑功能上是等效的，即对某一个具体功能来说，可以用硬件实现，也可以用软件实现。在设计一个计算机系统时，必须根据设计要求和现有技术与器件条件，首先确定哪些功能直接由硬件实现，哪些功能通过软件实现，这就是硬件和软件的功能分配。

### 计算机系统的工作原理

1. “存储程序”工作方式

   存储程序是指在用计算机解题之前，事先编写好程序，并连同所需的数据预先存入主存储器中。在解题过程（运行程序）中，由控制器按照事先编好并存入存储器中的程序自动地、连续地从存储器中依次取出指令并执行，直到获得所要求的结果为止。所以，存储程序方式是计算机能高速自动运行的基础。

2. 高级语言与机器语言程序之间的转换

   - 编译程序：也称编译器，用来将高级语言源程序翻译成汇编语言或机器语言目标程序。
   - 汇编程序：也称汇编器，用来将汇编语言源程序翻译成机器语言目标程序。
   - 解释程序：也称解释器，用来将源程序中的语句按其执行顺序逐条翻译成机器指令并立即执行。

3. 程序和指令的执行过程

   将事先编好的程序（指令序列）和数据送到计算机的主存储器内，然后计算机按此指令序列逐条完成全部指令的功能，直到程序结束。具体工作如下。

   - 把程序和数据装入主存储器。
   - 从程序的起始地址开始运行程序。
   - 从主存中取出一条指令，经过分析取数、执行等步骤控制计算机各功能部件协调运行，并计算下一条指令的地址，为取下一条指令做准备。
   - 重复上述步骤，周而复始，直到程序结束为止。

## 计算机的性能指标

1. 吞吐量：指系统在单位时间内处理请求的数量。

2. 响应时间：指从用户到计算机发送一个请求，到系统对该请求做出响应并获得所需结果的等待时间。

3. CPU时钟周期：通常为节拍脉冲或T周期，即主频的倒数，它是CPU中最小的时间单位，简称时钟周期。

4. 主频：机器内部主时钟的频率，是衡量机器速度的重要参数。通常以Hz（赫兹）为单位，1Hz表示每秒1次。

5. CPI：执行一条指令所需的时间周期数。

6. CPU执行时间：是指运行一个程序所花费的时间。
   $$
   CPU执行时间=\frac{CPU时钟周期数}{主频}=\frac{指令条数*CPI}{主频}
   $$

7. MIPS：表示每秒执行多少百万条指令：
   $$
   MIPS=\frac{指令条数}{执行时间*10^6}
   $$

8. MFLOPS、GFLOPS、TFLOPS、PFLOPS、EFLOPS、ZFLOPS。

   - MFLOPS：表示每秒执行百万次浮点运算。
     $$
     MFLOPS=\frac{浮点操作次数}{执行时间*10^6}
     $$

   - GFLOPS：表示每秒执行十亿次浮点运算。
     $$
     GFLOPS=\frac{浮点操作次数}{执行时间*10^9}
     $$

   - TFLOPS：表示每秒执行万亿次浮点运算。
     $$
     TFLOPS=\frac{浮点操作次数}{执行时间*10^{12}}
     $$

   - PFLOPS：表示每秒执行千万亿次浮点运算。
     $$
     PFLOPS=\frac{浮点操作次数}{执行时间*10^{15}}
     $$

   - EFLOPS：表示每秒执行一百京次浮点运算。
     $$
     EFLOPS=\frac{浮点操作次数}{执行时间*10^{18}}
     $$

   - ZFLOPS：表示每秒执行十万京次浮点运算
     $$
     ZFLOPS=\frac{浮点操作次数}{执行时间*10^{21}}
     $$

# 数据的表示和运算

## 数制与编码

### 进位计数制及其数据之间的相互转换

进位计数制有二进制、八进制、十进制、十六进制。二进制是计算机能够直接识别的进制，十进制是我们日常所学的加减法运算，十六进制在计算机组成原理中经常使用。现给出二进制数0010 1101 1101，将其转换为八进制、十六进制、十进制。

二进制->八进制：二进制中每3位为八进制的一位，所以结果为1335Q。

二进制->十六进制：二进制中每4位为十六进制的一位，所以结果为2DDH。

二进制->十进制：二进制数转换成十进制数，只需利用公式进行计算即可。计算的本质就是加权求和，所以结果为733。

八进制、十六进制和十进制转换成二进制，采用与上述相反的方法即可。

### 定点数的编码表示

定点数分为小数和定点整数。

- 定点小数：纯小数，小数点的位置隐含固定在最高有效位数位之前、符号位之后。
- 定点整数：纯整数，小数点的位置隐含固定在最低有效整数位之后。

## 整数的表示和运算

### 无符号整数的表示和运算

无符号数就是整个机器字长的全部二进制位均为数值位（没有符号），相当于数的绝对值。无符号数由于没有符号，所以它的运算按照正常的逢二进一来运算即可，但也要考虑溢出问题。

### 有符号整数的表示和运算

有符号数又分为源码、反码、补码、移码。现给出两个数15和-9，模拟计算机实现15和-9的相加过程。

1. 将15和-9转换成补码，其中符号位用1位表示

   原码转换成反码：正数不变，负数符号位不变，数值位取反。

   反码转换成补码：正数不变，负数符号位不变，数值位末位+1.

   |      | 原码  | 反码  | 补码  |
   | ---- | ----- | ----- | ----- |
   | 15   | 01111 | 01111 | 01111 |
   | -9   | 11001 | 10110 | 10111 |

2. 相加过程（采用双符号数计算）

   - 原码相加

     加法规则：先判断符号，若相同，则绝对值相加，结果符号位不变；若不同，则做减法，绝对值大的数减去绝对值小的数，结果符号位与绝对值大的数相同。

     减法规则：两个原码表示的数相减，首先将减数符号取反，然后将被减数与符号取反后的减数按原码加法进行运算。

     根据原码加法规则，符号不同，则做减法，绝对值大的数减去绝对值小的数，1111-1001=0110，符号位与绝对值大的数相同，即为整数，则最终结果为00110。

   - 补码相加

     此时结果为00110。

3. 判断是否溢出

   采用一位符号位根据符号判断：根据两个加数的符号和结果的符号是否相等，即两个正数相加结果变成了负数，两个负数相加结果变成了正数。

   采用双符号位：根据补码双符号位计算方式在运算的过程中，将符号位S变成两位Sf1Sf2，即正数时，Sf1Sf2=00，负数时，Sf1Sf2=11。但当计算结果出现Sf1Sf2=01或10时，就会发生溢出。01表示发生了正溢出，10表示发生了负溢出。

   采用一位符号位根据数据为的进位情况判断：最高数据位的进位和符号位的进位异或，即两个进位不同时，即发生溢出。两个数X和Y进行相加，Xn和Yn是最高数据为相加产生的进位Cn，Xf、Yf是符号位以及Cn，3个相加产生进位Cf，V=Cf+Cn，即Cf和Cn符号不一致时，发生溢出。

   上述结果000110，根据双符号位判断方式，可以得出未发生溢出。

## 浮点数的表示和运算

给出两个浮点数：
$$
\begin{align}
x&=+0.110101*2^{+0011}\\
y&=-0.111010*2^{+0010}
\end{align}
$$

### 浮点数的表示（IEEE 754 标准）

给出上述x的表示如下。

- 普通的自定义浮点格式类型

  浮点一般形式类型

  x的阶码：+0011，补码形式为00011。

  x的尾数：+110101，补码形式为110101。

  数符：0。

- IEEE 754 浮点单精度形式
  $$
  x=+0.110101*2^{+0011}=(-1)^0+(1.10101)*2^{129-127}
  $$
  x的尾数：10101。

  x的指数：10000001。

  x的符号位：0。

### 浮点数的加/减运算

两个浮点数相加。

1. 对阶（小阶向大阶对齐）。

   x的阶码为+3，y的阶码为+2。所以，y要右移一位，为
   $$
   0.011101*2^{+0011}
   $$

2. 尾数求和

3. 规格化（补码规格化）。

   01.0100100进行右移，得到00.101001(0)，阶码+1，阶码为4.

4. 舍入。

   右移之后产生的是0，直接舍弃就好。

5. 溢出判断。

   未溢出。最终结果为
   $$
   +0.101001*2^{00100}
   $$

6. 

## 运算方法和运算电路

### 基本运算部件

1. 加法器

   - 串行加法器：只有一个全加器，数据逐位串行送入加法器进行运算。
   - 并行加法器：由多个全加器组成，其位数的多少取决计算机的字长，数据的各位同时运算。

2. 算术逻辑部件

   算术逻辑部件（ALU）是既能完成算术运算又能完成逻辑运算的部件。由于加、减、乘、除最终都可归于加法运算，因此ALU的核心是一个并行加法器，同时还可以进行“与”“或”“非”等逻辑运算。

### 加/减运算

1. 补码加/减运算器

   补码加/减运算器带有各种符号标志位的产出。给出4位（包括符号位）两个数据
   $$
   \begin{align}
   [A]_补&=0001\\
   [B]_补&=0011
   \end{align}
   $$

2. 标志位的生成

   - ZF

     结果为0的标志；记录运算结果是否为0的状态，运算结果为0（全零）时ZF置1，否则ZF置0。

   - CF

     进位/借位标识符，记录最高位产生的进位C。加法运算时C=1，则CF置1，否则置0；减法运算时C=0，则CF置1，否则置0。CF标志只对无符号运算有意义。

   - OF

     溢出标志，用于反映有符号数加/减运算所得结果是否溢出。此时OF标志位为1，否则置0。OF标志只对带符号数运算有意义。

   - SF

     符号标志，记录运算结果的符号，它与运算结果的最高位相同。SF反映运算结果的正负。

   - PF

     奇偶标志，用于反映运算结果中“1”的个数的奇偶性，当结果操作数中“1”的个数为偶数时置1，否则置0。

     例：计算A和B相加，各符号标志位分别是什么？

   - A的真值为1，B的真值为3，按照补码加法运算规则计算结果为4，结果的补码为0100。

   - 未超出表示范围，未发生溢出，则此时的OF=0。

   - 结果不为0，ZF=0。

   - 符号位为0，SF=0.

   - 将A和B当作符号位来计算，结果仍未发生溢出，CF=0.

### 乘/除运算

乘/除法运算的基本原理为二进制的乘除运算，可以将乘除运算分解成多次累加和移位来实现，乘法运算每次做累加和右移操作，除法运算每次做累加和左移操作。

# 存储系统

## 存储器的分类

根据与CPU的连接和功能划分，可分为主存储器、辅助存储器、高速缓冲存储器。

按存取方式分类，可分为随机存储器（random access memory, RAM）、只读存储器（read-only memory, ROM）、顺序存取存储器、直接存取存储器。

按存储介质分类，可分为磁芯存储器、半导体存储器、磁表面存储器、光存储器。

半导体只读存储器又可分为掩膜ROM、可编程只读存储器（PROM）、紫外线擦除PROM、电操作PROM、内存存储器。

半导体随机存储器可分为静态随机存取存储器（static random-access memory, SRAM）和动态随机存储器（dynamic random access memory, DRAM）。其中SRAM的存储元件采用的是触发器，DRAM采用的是电容，因此DRAM需要刷新。

## 层次化存储器的基本结构

加入放在辅存中的数据调入到CPU中运行，则需要先经历从辅存到主存，再从主存到Cache的过程。而存储器的层次结构主要为：

1. Cache和主存之间，为解决CPU和主存之间速度不匹配问题；
2. 主存和辅存之间，解决主存容量不足的问题。

## 半导体存储器

### SRAM

SRAM的记忆单元是用双稳态触发器来记忆信息的。SRAM存取速度快，但集成度低，功耗也较大，所以一般用来组成高速缓冲存储器和小容量的主存系统。

### DRAM

DRAM是利用记忆单元电路中栅极电容上的电荷来存储信息的。DRAM集成度高，功耗小，但存取速度慢，一般用来组成大容量主存系统。由于栅极电容会不断泄漏，需要每隔一定时间进行刷新。刷新分为以下三种。

#### 集中式刷新

按照存储芯片容量大小集中安排刷新操作的时间段，在此时间段内对芯片内所有的存储单元电路进行刷新操作，在此期间禁止CPU对存储器进行正常的访问，称它为CPU的“死区”。

#### 分散式刷新

系统对存储器的存取周期是存储器本身的存取周期的两倍。把系统的存取周期平均分为两个操作阶段，前一个操作阶段用于存储器的正常访问，后一个阶段用于刷新操作，每次刷新一行。

#### 异步式刷新

前两个方法的结合，充分利用最大刷新间隔时间，把刷新操作平分到整个最大刷新间隔时间内进行。

### Flash 存储器

Flash 存储器又称为闪存存储器，它的主要特点是既能在不加电的情况下长期保存信息，又能在线进行快速擦除与重写，兼具电擦除可编程ROM和RAM的优点。

## 主存储器

### DRAM 芯片和内存条

将多个存储芯片扩展到一个主存模块上，就是我们生活中常见的内存条。内存条存储的信息通过引脚和内存插槽连接到主板，再连接到北桥芯片或者CPU芯片。

### 多模块存储器

多模块存储器的每一个模块都有独立的地址寄存器、数据寄存器、地址译码器、驱动电路和读/写电路，它们既能并行工作，又能交叉工作。多模块存储器可分为高位交叉编址和低位交叉编址两种。

#### 高位交叉编址

连续编址的多模块主存储器中，主存地址的高位表示模块号（或体号），低位表示模块内地址（或体内地址），因此，也称为按高位地址划分方式，地址在模块内连续。

#### 低位交叉编址

交叉编址存储器中，主存地址的低位表示模块号，高位表示模块内地址，因此，也称按低位地址划分方式。

### 主存和CPU之间的连接

主存和CPU之间的连接，一般涉及的是地址和数据两个方面的扩展。扩展方式如下。

#### 位扩展

用若干片位数较少的存储器芯片构成给定字长的内存条时，需要进行位扩展。

#### 字扩展

字扩展是容量的扩充，位数不变。

#### 字位扩展

当芯片在容量和位数都不满足存储器要求的情况下，需要对字和位同时扩展。

## 外部存储器

### 磁盘存储器

磁盘存储器的优点是：存储容量大，位价格低；存储介质可以重复使用；记录信息可以长期保存而不丢失，甚至可以脱机存档 。磁盘存储器包括硬磁盘和软磁盘。

### 固态硬盘

固态硬盘（SSD）不是磁表面存储器，而是一种使用NAND闪存组成的外部存储系统，它用闪存颗粒代替磁盘作为存储介质，利用闪存的特点，以区块写入和抹除的方式进行数据的读取和写入。

## 高速缓冲存储器（Cache）

### Cache 的基本原理 

Cache 采用的是程序的局部性原理，即空间局部性和时间局部性。空间局部性是指如果一个存储单元被访问，则该邻近的单元也有可能很快被访问。时间局部性是指如果一个存储单元被访问，则该单元可能很快被再次访问。

### Cache 和主存之间的映射方式

#### 直接映射

任何一个主存块只能复制到某一个固定的Cache块中。

#### 全相联映射

任意一个主存块可以复制到任意的Cache块中，两者之间的对应关系不存在任何限制。

#### 组相联映射

是前两种方式的折中，将Cache进行分组，每组中块数固定。主存中的任何一块只能存放到某一固定组中，但存放在该组哪一块是灵活的。

### Cache 中主存块的替换算法

#### 随机替换算法

在发生替换时，该算法随机挑选一个候选的Cache行进行替换，而与使用情况无关，其结果往往导致Cache的命中率很差。

#### 先进先出算法

在发生替换时，该算法把最先调入的那一个Cache行替换初期。

#### 近期最少使用算法

该算法统计哪一个Cache行是近段时间使用次数最少的Cache行，替换时需要将它替换出去。

### Cache 写策略

为了解决Cache与主存内容不一致的问题，需要选择合适的Cache更新策略，更新策略分为写回法和直写法。

#### 写回法

CPU将最新的数据只写入Cache中，但不写入内存。仅当Cache要替换数据时，才由Cache控制器将Cache中被替换的那个数据写入内存。

#### 直写法

数据被同时写入主存和Cache中。

## 虚拟存储器

### 虚拟存储器的基本概念

虚拟存储器将主存和辅存的地址空间统一编址，形成一个庞大的存储空间。在这个空间里，用户可以自由编程，用户编程的地址称为虚地址或逻辑地址，实际的主存单元地址称为实地址或物理地址。程序运行时，CPU以虚地址访问主存，由辅助硬件找到虚地址和实地址之间的对应关系。

### 页式虚拟存储器

#### 基本原理

主存空间和虚存空间都划分成若干大小相等的页。页式虚拟存储器的每页长度是固定的，页表的建立很方便，新页的调入也容易实现。

#### 页表

存放在主存中的页表称为慢表。

#### 地址转换

请求分页存储管理虚拟存储器，把程序的逻辑地址空间分为若干大小相等的块，称为逻辑页。相应的，把物理地址空间也划分为与逻辑页相同大小的若干个存储块，称为物理块或页框。

#### TLB 快表

将当前最常用的页表信息存放在一个小容量的高速存储器中，称为快表。

### 段式虚拟存储器

请求分段存储管理虚拟存储器，将程序按照逻辑结构划分为若干段，每个段再划分为若干个大小相等的逻辑页。

### 段页式虚拟存储器

请求段页式存储管理虚拟存储器，将程序按照逻辑结构划分为若干段，每个段再划分为若干个大小相等的逻辑页。

# 指令系统

## 指令系统的基本概念

## 指令格式

## 寻址方式

## 数据的对齐和大小端存储方式

## CISI和RISC的基本概念

## 高级语言程序与机器级代码之间的对应

# 中央处理器

## CPU的功能和基本结构

## 指令的执行过程

## 数据通路的功能和基本结构

## 控制器的功能和工作原理

## 异常和中断机制

## 指令流水线

## 多处理器基本概念

# 总线和输入/输出

## 总线概述

## I/O接口

#### I/O方式